#pragma once

/**
 * Frame classifier trained on aMGSIM ground truth.
 * Generated by train_frame_selector.py
 * Architecture: 30 -> 32 (ReLU) -> 1 (sigmoid)
 */

#include <array>
#include <cmath>
#include <algorithm>

namespace agp {
namespace frame_nn {

constexpr int INPUT_SIZE = 30;
constexpr int HIDDEN_SIZE = 32;

constexpr std::array<float, INPUT_SIZE> INPUT_MEAN = {{
    0.13676527f,
    0.39658947f,
    0.73242657f,
    0.46882767f,
    0.47110640f,
    0.47205607f,
    0.27582506f,
    0.22112150f,
    0.24770617f,
    0.25534728f,
    0.27639513f,
    0.22305796f,
    0.24804844f,
    0.25249848f,
    0.27688485f,
    0.22400775f,
    0.24804833f,
    0.25105910f,
    0.25095544f,
    0.43870246f,
    0.34521319f,
    0.02231404f,
    0.05361053f,
    0.47506684f,
    0.47456159f,
    0.41472380f,
    0.50189749f,
    0.46875179f,
    0.54764416f,
    0.54125962f
}};

constexpr std::array<float, INPUT_SIZE> INPUT_STD = {{
    0.21214833f,
    0.48918939f,
    0.36957284f,
    0.19027846f,
    0.19176237f,
    0.19290612f,
    0.14056538f,
    0.13408187f,
    0.14486912f,
    0.13895952f,
    0.14165270f,
    0.13581734f,
    0.14601870f,
    0.13982047f,
    0.14291241f,
    0.13720226f,
    0.14705521f,
    0.14069205f,
    0.13229396f,
    0.06838676f,
    0.16756484f,
    0.14770281f,
    0.22524750f,
    0.15723239f,
    0.38416281f,
    0.32225983f,
    0.24833748f,
    0.13099025f,
    0.16383729f,
    0.19752288f
}};

constexpr std::array<std::array<float, HIDDEN_SIZE>, INPUT_SIZE> W1 = {{
    {{0.60171354f, 0.58204812f, 1.35516250f, 0.33508316f, -0.41879380f, -0.62662226f, -0.82775396f, 1.32975864f, 1.01466572f, 1.34118807f, -0.55685866f, 0.18379885f, 0.01406767f, -0.65941685f, -0.52270252f, -0.38292921f, 0.21122301f, 0.74968576f, 0.79654658f, -0.37016085f, 0.00970337f, 0.09069228f, -0.09453773f, 0.27280158f, -0.06091912f, 0.76888776f, -0.54880011f, 0.13208878f, 0.46303800f, -0.33446664f, -0.31943953f, -0.59629411f}},
    {{-0.35432932f, 0.23959874f, 0.90313816f, -0.22113550f, -0.01464158f, -0.76254624f, -0.07236491f, 0.23629163f, -0.53502405f, 0.80964196f, 0.10646299f, 0.04491900f, -0.45540163f, -0.22158179f, -0.29400072f, 0.06881654f, -0.10698580f, 0.09013297f, 0.37809789f, -0.14724149f, 0.20700568f, 0.22215407f, 0.14279543f, 0.10771738f, 0.09141110f, -0.02091652f, -1.01103568f, -0.06967793f, 0.13916905f, 0.23251759f, 0.59986401f, 0.28422600f}},
    {{-0.15298857f, -0.04970443f, -0.44742084f, 0.14220425f, -0.04038401f, 0.60216779f, 0.80850953f, 0.17564660f, -0.12530923f, -0.20439549f, 0.05608629f, 0.35061118f, 0.45723817f, -1.05632532f, 0.32972291f, -0.28329387f, 0.41161081f, 0.20839940f, -0.21148448f, -1.13790894f, -0.89519960f, -0.06730102f, 0.24945579f, 0.19950625f, -0.15610538f, 0.25487891f, -1.28235209f, 0.02349447f, 0.12513067f, -0.16457061f, 0.34885767f, -0.11923728f}},
    {{0.00056807f, 0.35898048f, -0.41712549f, -0.42524871f, 0.11493800f, -0.33889702f, 0.07908504f, -0.16887812f, 0.59555578f, -0.22463043f, 0.03702461f, 0.54501271f, -0.18723871f, -0.13970475f, -0.02884427f, -0.16953519f, 0.31540689f, 0.35502270f, -0.43891016f, 0.18601625f, 0.16374104f, -0.32577819f, 0.22772506f, -0.19132419f, -0.03665993f, 0.22624817f, 0.00745312f, -0.34651977f, -0.48679164f, -0.49730262f, 0.04394748f, 0.03388010f}},
    {{-0.51262206f, 0.18054342f, -0.40408963f, -0.47923377f, -0.39772916f, -0.08283088f, -0.04490362f, 0.12151647f, 0.06247533f, 0.04189230f, -0.12750699f, 0.04625254f, 0.03894043f, -0.04905643f, 0.17612131f, 0.09836862f, 0.18799323f, -0.02832458f, 0.52107418f, -0.06281847f, -0.32959083f, 0.19805886f, 0.04164271f, -0.26462725f, 0.13064396f, -0.05548817f, 0.19281963f, 0.19855569f, -0.02179333f, 0.26744494f, -0.08590697f, -0.09974694f}},
    {{0.23929811f, -0.04015906f, 0.29935458f, 0.42798698f, -0.44474396f, 0.10698721f, -0.21740800f, -0.08550934f, -0.45199671f, -0.07820887f, -0.06831316f, -0.35859662f, 0.02758979f, -0.37851271f, 0.00177466f, -0.24833284f, -0.22898236f, -0.23238632f, 0.30757359f, -0.21730587f, 0.02230258f, -0.03420295f, 0.44642264f, 0.44693825f, -0.40581700f, 0.19135374f, 0.06217251f, 0.03472988f, 0.04592750f, -0.11970183f, -0.36683869f, 0.50089729f}},
    {{0.32664093f, -0.63956696f, 0.05961820f, -0.09285659f, -0.00043654f, 0.66380304f, 0.10997060f, 0.38684556f, -0.32862660f, -0.17592223f, -0.43236303f, 0.39382383f, 0.17836063f, -0.32970539f, -0.41211444f, -0.02488552f, -0.54770780f, 0.36677799f, 0.37131912f, 0.48716375f, 0.26829696f, -0.50520271f, 0.25664443f, 0.06355291f, 0.01573083f, -0.04606232f, -0.08668341f, 0.10584592f, 0.19941638f, 0.20985973f, 0.05244269f, 0.09869204f}},
    {{-0.40492433f, 0.05232858f, 0.14292252f, -0.03640335f, 0.27221531f, -0.06138822f, -0.16682222f, -0.08168044f, 0.49952614f, -0.21718328f, -0.35176951f, 0.14464138f, -0.28792736f, -0.25510100f, 0.22766328f, 0.01309483f, 0.45628566f, 0.58034050f, 0.02644105f, -0.18678582f, -0.17099848f, 0.82491773f, -0.13545059f, -0.08629846f, 0.22251792f, 0.46117079f, 0.15857998f, -0.44738948f, -0.05686393f, -0.43976536f, -0.53751779f, -0.24818072f}},
    {{0.37738320f, 0.41854334f, 0.04135560f, -0.58986348f, 0.50953066f, -0.02378849f, 0.21299778f, -0.15291733f, 0.30144992f, 0.27014169f, 0.32392359f, 0.53643191f, -0.01356094f, 0.01579474f, 0.17959459f, 0.12478032f, 0.15045223f, 0.12495793f, -0.31197485f, 0.05550356f, 0.09330226f, -0.62736773f, 0.17199720f, 0.36919039f, -0.01099874f, -0.33509490f, -0.09999449f, -0.09496872f, -0.12983130f, -0.46308771f, 0.14882144f, 0.09621705f}},
    {{-0.04428243f, 0.25190115f, -0.21100990f, 0.01969733f, -0.26548767f, 0.00191576f, -0.36645386f, 0.11600247f, 0.01830713f, -0.18315274f, 0.26701137f, -0.99539047f, -0.31790721f, -0.02521285f, 0.17461577f, 0.11718607f, 0.30778384f, -0.45229265f, 0.33588082f, -0.42750856f, 0.05928123f, 0.40782505f, -0.14151031f, -0.23623824f, -0.06890538f, 0.50101417f, 0.20083895f, 0.53696913f, 0.25271288f, 0.25029436f, -0.40901300f, -0.12522532f}},
    {{-0.28071499f, -0.13659935f, 0.13651557f, -0.21141379f, 0.00819371f, 0.26268321f, 0.89672744f, 0.17517765f, -0.17802994f, -0.25383618f, -0.02546270f, 0.57850820f, -0.34186235f, -0.28114614f, -0.51473343f, -0.55756712f, 0.45739883f, 0.81227624f, -0.74077386f, -0.25884351f, 0.08285493f, -0.07499122f, -0.08694474f, -0.14184107f, -0.33495364f, -0.03328497f, 0.15427065f, -0.11886169f, -0.28218883f, 0.00226951f, 0.28563759f, 0.07692830f}},
    {{-0.36713636f, 0.43029922f, -0.17080390f, 0.19833082f, -0.25518513f, -0.02136164f, -0.07371692f, -0.19703513f, -0.11783087f, 0.32457396f, -0.26699153f, -0.00957550f, -0.42507690f, -0.00832046f, 0.37558845f, 0.84160703f, -0.44892317f, -0.22385319f, 0.26983401f, 0.03310392f, -0.21779212f, 0.24999700f, -0.12411259f, -0.23839290f, 0.24405572f, -0.85423756f, -0.01606329f, 0.12430198f, 0.14480531f, 0.14700632f, 0.23615462f, 0.30455610f}},
    {{0.29722989f, -0.23135731f, -0.53614014f, -0.74394345f, -0.30195746f, 0.32886183f, 0.15258576f, 0.53738976f, 0.08744787f, -0.20886239f, 0.04840710f, 0.07774058f, 0.57520801f, 0.07635444f, 0.23053418f, -0.21445535f, 0.45873547f, 0.59107375f, 0.07931571f, -0.31063211f, -0.26607308f, 0.43754950f, -0.45748234f, -0.29028517f, 0.76768196f, 0.20508449f, -0.07705244f, 0.46615076f, -0.22963488f, 0.20797509f, 0.09151923f, -0.44420058f}},
    {{0.40627244f, -0.00037793f, 0.52568650f, 0.61258417f, 0.59177631f, -0.01480632f, -0.68273187f, -0.45690927f, -0.19528583f, 0.26659045f, -0.00150732f, 0.05784443f, 0.31455201f, -0.29941216f, -0.12583192f, 0.15820974f, -0.63659024f, -1.49915159f, -0.12288602f, 0.19223459f, -0.26373893f, -0.19001859f, 0.29827261f, -0.04052455f, -0.47382903f, 0.41599792f, 0.06333871f, -0.75237149f, 0.48126072f, 0.16929947f, -0.02560989f, 0.63052171f}},
    {{-0.64101774f, -0.14944923f, 0.21927376f, 0.04000270f, 0.08709078f, 0.64210039f, 0.11344451f, -0.37603685f, -0.09087577f, 0.15868855f, -0.51413327f, 0.02532686f, -0.23548150f, 0.22532403f, 0.40703776f, 0.14314188f, 0.27049932f, 0.18557753f, -0.00815022f, 0.11209408f, -0.10014907f, -0.00119125f, -0.08658816f, -0.07819752f, -0.01816394f, 0.03802409f, 0.03677664f, 0.08450947f, -0.12133437f, 0.10953908f, 0.39682478f, 0.06906081f}},
    {{0.15836434f, -0.15791413f, -0.24302335f, -0.15713502f, -0.14512211f, 0.05361115f, -0.09001595f, 0.37284294f, 0.27670556f, 0.04806520f, 0.21695769f, 0.20122521f, -0.00642844f, -0.49070364f, 0.10457985f, -0.28631106f, 0.10432339f, -0.05301527f, 0.12658209f, 0.24781169f, 0.06588949f, 0.11867427f, 0.58873135f, 0.34346110f, 0.15686193f, -0.09717214f, 0.16353212f, 0.12841165f, 0.23039125f, 0.04416191f, -0.02655667f, -0.09664738f}},
    {{0.46641901f, 0.35848576f, 0.20284341f, 0.38063118f, -0.15089920f, 0.21517690f, 0.03506543f, -0.52351618f, -0.17386857f, -0.03754203f, -0.07809879f, -0.02587804f, 0.15536927f, -0.03975212f, -0.19926073f, -0.03411825f, -0.80639535f, -0.18106520f, 0.35447645f, 0.36408463f, 0.45568836f, 0.24160644f, -0.25844550f, 0.42053184f, -0.15653923f, -0.15914550f, -0.06093212f, -0.12864974f, 0.40963730f, 0.17619099f, -0.23042554f, 0.48709673f}},
    {{0.19691600f, -0.02680078f, -0.64914811f, -0.51689953f, 0.10098719f, -0.11841705f, -0.19942041f, 0.43250909f, 0.07084431f, 0.01698743f, 0.66031653f, -0.22309867f, -0.24391101f, -0.15464716f, 0.01758683f, 0.04584944f, 0.59007794f, -0.16912909f, -0.36933827f, -0.09632527f, -0.31355277f, 0.06517386f, -0.57153022f, 0.03095431f, 0.33730692f, 0.02443355f, 0.17466080f, 0.37933052f, -0.26761582f, -0.05321716f, 0.24858236f, -0.15100010f}},
    {{-0.25930938f, 0.07364120f, 0.13592763f, -0.00025716f, -0.20413300f, -0.26590991f, 0.04362707f, -0.26282829f, -0.04882622f, -0.02000709f, -0.10058338f, -0.07372309f, -0.44225231f, 0.58728808f, 0.56095147f, -0.07582463f, -0.04024887f, 0.06708666f, -0.13845344f, -0.06576134f, 0.43672886f, -0.10149735f, -0.08813275f, -0.11485889f, -0.29604030f, -0.07618534f, -0.17591286f, -0.06807504f, 0.03497914f, 0.08490200f, -0.36907193f, 0.02609069f}},
    {{0.18503252f, 0.05962326f, 0.56123555f, 0.17269841f, 0.40707466f, -0.30635309f, -0.02503007f, 0.35011894f, 0.40337157f, -0.35747382f, 0.44974717f, 0.13441603f, -0.85999966f, 0.07819383f, -0.18860972f, 0.00222485f, -0.10506599f, 0.25200725f, 0.63902479f, 0.20845461f, -0.03495457f, 0.16331683f, 0.19534913f, 0.63241291f, 0.29576570f, 0.31043068f, 0.04509318f, 0.61616719f, -0.25363740f, 0.07937502f, -0.13414876f, 0.43772140f}},
    {{-0.02430165f, -0.68985200f, 0.13600980f, -0.02381489f, 0.13951959f, -0.03267581f, -0.25330728f, 0.07723919f, 0.05420418f, -0.67593628f, 0.21347582f, 0.26267329f, -0.18939960f, 0.31148565f, 0.52096105f, 0.35794389f, -0.02174567f, -0.27126455f, 0.19257240f, 0.02162568f, -0.15596661f, 0.74498677f, 0.28033584f, -0.13440214f, -0.19827770f, -0.09348085f, 0.07432489f, -0.07167500f, -0.79044712f, -0.09096423f, 0.10438050f, 0.36205950f}},
    {{0.05516233f, 0.16163179f, -0.01870950f, 0.21808302f, 0.09316469f, -0.00058557f, -0.05508494f, -0.01388287f, -0.01243047f, 0.03595424f, -0.03320180f, 0.19288635f, 0.06344281f, -0.03389395f, 0.04353962f, 0.16631860f, -0.02561544f, -0.03076972f, 0.16362272f, -0.35865662f, 0.03251681f, -0.08836564f, 0.10705524f, 0.01609220f, -0.08729602f, -0.06438455f, -0.02990700f, 0.36711872f, -0.09562450f, -1.46422601f, -0.03416243f, 0.08224791f}},
    {{-0.29161853f, 0.64875257f, -0.03777884f, -0.08618239f, 0.11960430f, -0.09194560f, -0.02933814f, 0.17709754f, -0.20118906f, 0.52506274f, -0.07028838f, 0.19650573f, 0.13320099f, 0.02634857f, -0.29003528f, -0.15102497f, -0.04257411f, -0.25309974f, -0.13603187f, 0.44220692f, 0.19196157f, 0.55736876f, -0.12328557f, 0.02874849f, -0.43603170f, 0.07604427f, -0.13438956f, -0.30223888f, -0.06124441f, -0.09431075f, 0.16548584f, 0.03439593f}},
    {{0.18413842f, -0.00157656f, -0.51561511f, -0.76083261f, -0.10120030f, -0.55134702f, 0.10668587f, 0.58059311f, -0.09521864f, 0.08151202f, 0.51255167f, 0.01311377f, 0.32012081f, -0.10712971f, -0.31183249f, 0.08324489f, 0.54346991f, 0.07996854f, -0.45196745f, 0.25177705f, -0.19613852f, 0.15537503f, 0.48627332f, 0.33698484f, -0.10317683f, 0.06110410f, -0.13538016f, 0.26609045f, -0.58605802f, -0.15197971f, 0.09886479f, -0.22059470f}},
    {{-0.46148312f, 0.37219068f, -0.07244110f, 0.07173745f, -0.04703195f, -0.03632708f, 0.03578410f, -0.45748746f, -0.11203694f, -0.01026895f, -0.03227917f, 0.40308979f, 0.35897619f, -0.49291453f, -0.71917415f, 0.07001044f, 0.09097815f, 0.19614434f, 0.10304374f, 0.12066625f, 0.04711133f, -0.10107560f, -0.29559585f, -0.18448007f, -0.23395345f, -0.01685989f, 0.06559845f, 0.39020932f, -0.01450171f, 0.21597950f, 0.21291955f, 0.10890489f}},
    {{0.27073932f, 0.33835593f, -0.21247435f, 0.00566192f, 0.19967650f, -0.15216850f, 0.13053273f, -0.15225083f, 0.13325736f, 0.17637482f, 0.67002887f, -0.22416310f, -0.10993327f, 0.35326299f, 0.17063318f, -0.49296364f, -0.01914116f, -0.47557357f, 0.21518339f, -0.48743457f, -0.00621989f, -0.19662964f, -0.29021478f, 0.35691053f, -0.17671393f, 0.75058699f, 0.20320009f, -0.12299322f, 0.25633821f, 0.11697584f, -0.25452590f, 0.07741811f}},
    {{0.35614902f, 0.24669571f, -0.00722334f, -0.24937089f, 0.25451699f, -0.17987232f, -0.07023421f, 0.27828404f, -0.15618221f, 0.03466089f, 0.17333473f, -0.03243336f, -0.20992482f, 0.08674915f, 0.01702219f, 0.01908981f, -0.07076477f, 0.06697515f, -0.05033499f, -0.17389649f, -0.24538502f, 0.00189280f, -0.34719589f, -0.03966535f, -0.43737659f, -0.61792696f, 0.29252931f, 0.46986279f, -0.00502628f, 0.13785112f, 0.07559325f, -0.02912454f}},
    {{-0.17958908f, 0.24797894f, -0.18807366f, -0.13407624f, -0.08043843f, 0.15447848f, -0.40758285f, -0.28523698f, 0.16517261f, -0.01835466f, -0.46455461f, 0.14478454f, 0.01631827f, -0.07263049f, -0.75028169f, -0.74614435f, -0.30816665f, 0.09028794f, -0.17695341f, -0.08293572f, 0.78385901f, -0.05901018f, 0.53693885f, 0.50414848f, -0.21555994f, -0.27437678f, 0.32302070f, 0.32813495f, 0.07535326f, 0.00127101f, -0.60265636f, -0.25693151f}},
    {{-0.52739584f, 0.64880466f, -0.51841199f, -0.32445303f, 0.16871572f, 0.17167835f, -0.11516783f, 0.27342612f, 0.04297017f, 0.68019450f, 0.29320857f, 0.30101618f, -0.41190386f, -0.20030281f, 0.44611496f, 0.03174128f, 0.39403963f, 0.36684921f, -0.12792109f, -0.37200594f, -0.47957566f, 1.02324116f, 0.50948799f, -0.43923119f, -0.35339129f, 0.11839801f, 0.40776223f, -0.05216319f, -0.31112722f, -0.32090396f, 0.14340594f, 0.00118185f}},
    {{0.10360329f, 0.21895668f, -0.22971843f, 0.47790805f, 0.63336915f, 0.34841433f, -0.23563886f, 0.10446054f, -0.12867177f, 0.39680582f, -0.34069836f, 0.11341042f, -0.23342165f, -0.05593271f, 0.15167640f, 0.37316242f, 0.07394928f, -0.08366735f, -0.56544757f, 0.04318803f, -0.12543862f, 0.58789843f, 0.20232664f, -0.22622125f, -0.35294262f, 0.34250852f, 0.07970754f, 0.12382843f, 0.08618202f, -0.09221826f, -0.38071755f, 0.39952341f}}
}};

constexpr std::array<float, HIDDEN_SIZE> B1 = {{
    -0.38924271f, 0.21813992f, 0.01119679f, -0.24560942f, -0.21349479f, 0.21558520f, 0.56487197f, -0.71696401f, -1.55869234f, 0.18919834f, 0.50262445f, -0.07601240f, 0.12995003f, -0.94144255f, -0.63220197f, -0.47642064f, 0.10712928f, -0.37404707f, -0.48968345f, -0.22507316f, -0.68691194f, 0.08935791f, -0.37530163f, -1.47950673f, 1.02962947f, -0.41280082f, -0.45859614f, 0.62233233f, -1.33740461f, 1.43314743f, 0.85260582f, 0.86143965f
}};

constexpr std::array<float, HIDDEN_SIZE> W2 = {{
    -0.38475388f, -0.27151853f, -0.57234138f, -0.57440019f, 0.22062378f, -0.37061849f, 0.41252917f, -0.41972664f, -1.07457352f, -0.41110849f, 0.45953023f, 0.23093550f, 0.25342226f, 0.61768204f, 0.44379154f, 0.30828321f, -0.44669199f, -0.41465566f, -0.43262431f, 0.49555787f, 0.51852310f, -0.82864916f, 0.29641017f, 1.00183785f, -0.35530129f, -0.33462781f, 1.08303142f, -0.35586768f, 0.63967228f, -0.55532521f, 0.45436275f, 0.60911220f
}};

constexpr float B2 = -0.05404427f;

/**
 * Extract 30 features for frame classification.
 * Must match extract_features() in train_frame_selector.py exactly.
 */
inline std::array<float, INPUT_SIZE> extract_features(const char* seq, size_t len, int frame) {
    std::array<float, INPUT_SIZE> features{};
    
    if (len < static_cast<size_t>(frame + 6)) {
        return features;  // Return zeros
    }
    
    // Count codons and stats
    int n_codons = 0;
    int internal_stops = 0;
    int first_stop_pos = -1;
    int gc_pos[3] = {0, 0, 0};
    int total_pos[3] = {0, 0, 0};
    int nt_freq[3][4] = {{0}};  // [position][A,C,G,T]
    int rny_count = 0;
    
    // First pass: count codons and positions
    for (size_t i = frame; i + 2 < len; i += 3) {
        char c0 = seq[i], c1 = seq[i+1], c2 = seq[i+2];
        if (c0 == 'N' || c1 == 'N' || c2 == 'N') continue;
        
        n_codons++;
        
        // Check for stop codon
        bool is_stop = (c0 == 'T' && c1 == 'A' && c2 == 'A') ||
                       (c0 == 'T' && c1 == 'A' && c2 == 'G') ||
                       (c0 == 'T' && c1 == 'G' && c2 == 'A');
        
        // Internal stops (exclude last codon)
        if (is_stop && i + 5 < len) {
            internal_stops++;
            if (first_stop_pos < 0) first_stop_pos = static_cast<int>(n_codons - 1);
        }
        
        // RNY rule (R at pos 0, Y at pos 2)
        if ((c0 == 'A' || c0 == 'G') && (c2 == 'C' || c2 == 'T')) {
            rny_count++;
        }
    }
    
    if (n_codons < 2) return features;
    
    // Position-specific nucleotide counts
    for (size_t i = frame; i < len; i++) {
        int pos = (i - frame) % 3;
        char c = seq[i];
        if (c == 'N') continue;
        
        total_pos[pos]++;
        if (c == 'G' || c == 'C') gc_pos[pos]++;
        
        int nt_idx = (c == 'A') ? 0 : (c == 'C') ? 1 : (c == 'G') ? 2 : 3;
        nt_freq[pos][nt_idx]++;
    }
    
    // Feature 0: Internal stop count normalized
    features[0] = std::min(internal_stops, 5) / 5.0f;
    
    // Feature 1: Has any internal stop
    features[1] = (internal_stops > 0) ? 1.0f : 0.0f;
    
    // Feature 2: First stop position normalized
    features[2] = (first_stop_pos >= 0) ? static_cast<float>(first_stop_pos) / n_codons : 1.0f;
    
    // Features 3-5: GC per position
    for (int p = 0; p < 3; p++) {
        features[3 + p] = total_pos[p] > 0 ? static_cast<float>(gc_pos[p]) / total_pos[p] : 0.5f;
    }
    
    // Features 6-17: Nucleotide freq per position (12 features)
    for (int pos = 0; pos < 3; pos++) {
        int total = total_pos[pos] > 0 ? total_pos[pos] : 1;
        for (int nt = 0; nt < 4; nt++) {
            features[6 + pos * 4 + nt] = static_cast<float>(nt_freq[pos][nt]) / total;
        }
    }
    
    // Feature 18: RNY compliance
    features[18] = static_cast<float>(rny_count) / n_codons;
    
    // Feature 19: Dipeptide entropy (simplified - use 0.5 as default)
    features[19] = 0.5f;  // Could compute properly but expensive
    
    // Feature 20: Length normalized
    features[20] = std::min(1.0f, static_cast<float>(n_codons) / 50.0f);
    
    // Feature 21: Has start codon
    if (len >= static_cast<size_t>(frame + 3)) {
        features[21] = (seq[frame] == 'A' && seq[frame+1] == 'T' && seq[frame+2] == 'G') ? 1.0f : 0.0f;
    }
    
    // Feature 22: Has terminal stop
    if (n_codons > 0) {
        size_t last_codon = frame + (n_codons - 1) * 3;
        if (last_codon + 2 < len) {
            char c0 = seq[last_codon], c1 = seq[last_codon+1], c2 = seq[last_codon+2];
            bool is_stop = (c0 == 'T' && c1 == 'A' && c2 == 'A') ||
                           (c0 == 'T' && c1 == 'A' && c2 == 'G') ||
                           (c0 == 'T' && c1 == 'G' && c2 == 'A');
            features[22] = is_stop ? 1.0f : 0.0f;
        }
    }
    
    // Feature 23: Pyrimidine at wobble position
    int pyr_wobble = 0;
    for (size_t i = frame + 2; i < len; i += 3) {
        if (seq[i] == 'C' || seq[i] == 'T') pyr_wobble++;
    }
    features[23] = static_cast<float>(pyr_wobble) / std::max(1, n_codons);
    
    // Features 24-26: Dinucleotide bias
    int cpg = 0, tpa = 0, aa_tt = 0;
    for (size_t i = 0; i + 1 < len; i++) {
        if (seq[i] == 'C' && seq[i+1] == 'G') cpg++;
        if (seq[i] == 'T' && seq[i+1] == 'A') tpa++;
        if ((seq[i] == 'A' && seq[i+1] == 'A') || (seq[i] == 'T' && seq[i+1] == 'T')) aa_tt++;
    }
    int half_len = std::max(1, static_cast<int>(len / 2));
    features[24] = static_cast<float>(cpg) / half_len * 4;
    features[25] = static_cast<float>(tpa) / half_len * 4;
    features[26] = static_cast<float>(aa_tt) / half_len * 2;
    
    // Feature 27: GC content overall
    int gc_total = gc_pos[0] + gc_pos[1] + gc_pos[2];
    int total_nt = total_pos[0] + total_pos[1] + total_pos[2];
    features[27] = total_nt > 0 ? static_cast<float>(gc_total) / total_nt : 0.5f;
    
    // Feature 28: Purine at position 1
    int pur_pos1 = 0;
    for (size_t i = frame; i < len; i += 3) {
        if (seq[i] == 'A' || seq[i] == 'G') pur_pos1++;
    }
    features[28] = static_cast<float>(pur_pos1) / std::max(1, n_codons);
    
    // Feature 29: A/T at position 2
    int at_pos2 = 0;
    for (size_t i = frame + 1; i < len; i += 3) {
        if (seq[i] == 'A' || seq[i] == 'T') at_pos2++;
    }
    features[29] = static_cast<float>(at_pos2) / std::max(1, n_codons);
    
    return features;
}

/**
 * Score a frame using the trained neural network.
 */
inline float score_frame(const std::array<float, INPUT_SIZE>& features) {
    std::array<float, INPUT_SIZE> x;
    for (int i = 0; i < INPUT_SIZE; i++)
        x[i] = (features[i] - INPUT_MEAN[i]) / INPUT_STD[i];

    std::array<float, HIDDEN_SIZE> h;
    for (int j = 0; j < HIDDEN_SIZE; j++) {
        float sum = B1[j];
        for (int i = 0; i < INPUT_SIZE; i++)
            sum += x[i] * W1[i][j];
        h[j] = std::max(0.0f, sum);
    }

    // Binary output with sigmoid
    float z = B2;
    for (int j = 0; j < HIDDEN_SIZE; j++)
        z += h[j] * W2[j];
    return 1.0f / (1.0f + std::exp(-std::clamp(z, -20.0f, 20.0f)));
}

/**
 * Score a frame with damage-aware feature masking.
 * For damaged ancient DNA, stop-related features are unreliable because
 * Câ†’T damage creates stops in the TRUE frame. This masks stop features
 * (indices 0, 1, 2, 22) to their mean values, preventing them from biasing
 * the NN toward wrong frames.
 */
inline float score_frame_damage_aware(const std::array<float, INPUT_SIZE>& features) {
    std::array<float, INPUT_SIZE> x;
    for (int i = 0; i < INPUT_SIZE; i++) {
        // Mask stop-related features to mean (results in 0 after normalization)
        // Feature 0: Internal stops normalized
        // Feature 1: Has internal stop
        // Feature 2: First stop position normalized
        // Feature 22: Has terminal stop
        if (i == 0 || i == 1 || i == 2 || i == 22) {
            x[i] = 0.0f;  // Mean-normalized = 0 -> no contribution
        } else {
            x[i] = (features[i] - INPUT_MEAN[i]) / INPUT_STD[i];
        }
    }

    std::array<float, HIDDEN_SIZE> h;
    for (int j = 0; j < HIDDEN_SIZE; j++) {
        float sum = B1[j];
        for (int i = 0; i < INPUT_SIZE; i++)
            sum += x[i] * W1[i][j];
        h[j] = std::max(0.0f, sum);
    }

    float z = B2;
    for (int j = 0; j < HIDDEN_SIZE; j++)
        z += h[j] * W2[j];
    return 1.0f / (1.0f + std::exp(-std::clamp(z, -20.0f, 20.0f)));
}

} // namespace frame_nn
} // namespace agp
