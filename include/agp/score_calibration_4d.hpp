#pragma once

// Auto-generated 4D calibration for AGP
// P(correct|score, length, damage_pct, damage_signal)

#include <cstddef>
#include <algorithm>

namespace agp {

namespace detail_4d {

constexpr size_t N_SCORE_BINS = 10;
constexpr size_t N_LENGTH_BINS = 5;
constexpr size_t N_DAMAGE_BINS = 4;
constexpr size_t N_ANCIENT_BINS = 4;

constexpr float SCORE_EDGES[] = {0.3000f, 0.3700f, 0.4400f, 0.5100f, 0.5800f, 0.6500f, 0.7200f, 0.7900f, 0.8600f, 0.9300f, 1.0000f};
constexpr float LENGTH_EDGES[] = {30.0f, 50.0f, 70.0f, 100.0f, 150.0f, 300.0f};
constexpr float DAMAGE_EDGES[] = {0.0f, 10.0f, 25.0f, 50.0f, 100.0f};
constexpr float ANCIENT_EDGES[] = {0.0000f, 0.5000f, 0.7000f, 0.8500f, 1.0000f};

// 4D lookup table [score][length][damage][ancient]
constexpr float CALIBRATION_4D[10][5][4][4] = {
  { // score bin 0
    { // length bin 0
      {0.7111f, 0.7241f, 0.7225f, 0.7842f},
      {0.7201f, 0.6987f, 0.7248f, 0.7127f},
      {0.7201f, 0.7661f, 0.7184f, 0.7133f},
      {0.7201f, 0.7201f, 0.7143f, 0.7294f},
    },
    { // length bin 1
      {0.7547f, 0.7661f, 0.7632f, 0.7469f},
      {0.7646f, 0.7462f, 0.7602f, 0.8003f},
      {0.7646f, 0.7629f, 0.7700f, 0.7616f},
      {0.7646f, 0.7646f, 0.8069f, 0.7817f},
    },
    { // length bin 2
      {0.7971f, 0.8091f, 0.8009f, 0.8079f},
      {0.8101f, 0.8142f, 0.8134f, 0.8102f},
      {0.8101f, 0.8208f, 0.8114f, 0.8146f},
      {0.8101f, 0.8101f, 0.8214f, 0.8208f},
    },
    { // length bin 3
      {0.7541f, 0.7759f, 0.7536f, 0.7565f},
      {0.7792f, 0.7747f, 0.7751f, 0.7603f},
      {0.7792f, 0.7742f, 0.7951f, 0.8054f},
      {0.7792f, 0.7792f, 0.8359f, 0.8008f},
    },
    { // length bin 4
      {0.5379f, 0.6039f, 0.5836f, 0.5714f},
      {0.5756f, 0.5797f, 0.5918f, 0.5227f},
      {0.5756f, 0.5756f, 0.5312f, 0.5859f},
      {0.5756f, 0.5756f, 0.5756f, 0.5528f},
    },
  },
  { // score bin 1
    { // length bin 0
      {0.7130f, 0.7215f, 0.7460f, 0.7559f},
      {0.7244f, 0.7196f, 0.7164f, 0.7304f},
      {0.7244f, 0.7009f, 0.7200f, 0.7306f},
      {0.7244f, 0.7244f, 0.7715f, 0.7353f},
    },
    { // length bin 1
      {0.7910f, 0.7902f, 0.7828f, 0.7884f},
      {0.7927f, 0.7826f, 0.7966f, 0.8155f},
      {0.7927f, 0.7996f, 0.7957f, 0.7993f},
      {0.7927f, 0.7927f, 0.8278f, 0.7960f},
    },
    { // length bin 2
      {0.8357f, 0.8404f, 0.8491f, 0.8638f},
      {0.8418f, 0.8518f, 0.8424f, 0.8418f},
      {0.8418f, 0.8269f, 0.8360f, 0.8444f},
      {0.8418f, 0.8418f, 0.8966f, 0.8375f},
    },
    { // length bin 3
      {0.7857f, 0.7931f, 0.7810f, 0.7725f},
      {0.8043f, 0.8065f, 0.8248f, 0.7886f},
      {0.8043f, 0.7850f, 0.8193f, 0.8112f},
      {0.8043f, 0.8043f, 0.8456f, 0.8361f},
    },
    { // length bin 4
      {0.5748f, 0.6206f, 0.5840f, 0.5128f},
      {0.5861f, 0.5702f, 0.5686f, 0.5918f},
      {0.5861f, 0.5861f, 0.5495f, 0.6081f},
      {0.5861f, 0.5861f, 0.5861f, 0.5749f},
    },
  },
  { // score bin 2
    { // length bin 0
      {0.7495f, 0.7533f, 0.7649f, 0.7740f},
      {0.7509f, 0.7402f, 0.7496f, 0.7580f},
      {0.7509f, 0.7626f, 0.7438f, 0.7521f},
      {0.7509f, 0.7509f, 0.7379f, 0.7372f},
    },
    { // length bin 1
      {0.8106f, 0.8146f, 0.8257f, 0.7901f},
      {0.8144f, 0.8119f, 0.8245f, 0.7916f},
      {0.8144f, 0.7800f, 0.8162f, 0.8052f},
      {0.8144f, 0.8144f, 0.8108f, 0.8212f},
    },
    { // length bin 2
      {0.8638f, 0.8661f, 0.8591f, 0.8911f},
      {0.8666f, 0.8604f, 0.8644f, 0.8805f},
      {0.8666f, 0.8530f, 0.8695f, 0.8623f},
      {0.8666f, 0.8666f, 0.9146f, 0.8833f},
    },
    { // length bin 3
      {0.7979f, 0.8158f, 0.8145f, 0.7888f},
      {0.8189f, 0.8175f, 0.8153f, 0.8232f},
      {0.8189f, 0.8182f, 0.8326f, 0.8248f},
      {0.8189f, 0.8189f, 0.7941f, 0.8468f},
    },
    { // length bin 4
      {0.6054f, 0.5836f, 0.6043f, 0.6389f},
      {0.5950f, 0.6322f, 0.6000f, 0.6222f},
      {0.5950f, 0.5556f, 0.6199f, 0.5804f},
      {0.5950f, 0.5950f, 0.5950f, 0.5345f},
    },
  },
  { // score bin 3
    { // length bin 0
      {0.7813f, 0.7769f, 0.7863f, 0.7968f},
      {0.7728f, 0.7583f, 0.7776f, 0.7880f},
      {0.7728f, 0.7533f, 0.7659f, 0.7624f},
      {0.7728f, 0.7728f, 0.7510f, 0.7452f},
    },
    { // length bin 1
      {0.8447f, 0.8388f, 0.8509f, 0.8576f},
      {0.8342f, 0.8108f, 0.8317f, 0.8353f},
      {0.8342f, 0.8107f, 0.8249f, 0.8319f},
      {0.8342f, 0.8342f, 0.8371f, 0.8228f},
    },
    { // length bin 2
      {0.8777f, 0.8798f, 0.8853f, 0.8991f},
      {0.8801f, 0.8857f, 0.8788f, 0.8687f},
      {0.8801f, 0.8658f, 0.8815f, 0.8810f},
      {0.8801f, 0.8801f, 0.8671f, 0.8763f},
    },
    { // length bin 3
      {0.8199f, 0.8206f, 0.8216f, 0.7931f},
      {0.8286f, 0.8271f, 0.8262f, 0.8079f},
      {0.8286f, 0.8481f, 0.8375f, 0.8502f},
      {0.8286f, 0.8286f, 0.9023f, 0.8423f},
    },
    { // length bin 4
      {0.6267f, 0.6240f, 0.6497f, 0.6977f},
      {0.6227f, 0.6335f, 0.5863f, 0.5902f},
      {0.6227f, 0.6227f, 0.6231f, 0.6034f},
      {0.6227f, 0.6227f, 0.6227f, 0.6312f},
    },
  },
  { // score bin 4
    { // length bin 0
      {0.7913f, 0.8009f, 0.8120f, 0.8284f},
      {0.7916f, 0.7592f, 0.7899f, 0.8259f},
      {0.7916f, 0.7511f, 0.7720f, 0.7986f},
      {0.7916f, 0.7916f, 0.7672f, 0.7588f},
    },
    { // length bin 1
      {0.8571f, 0.8607f, 0.8513f, 0.8832f},
      {0.8505f, 0.8289f, 0.8460f, 0.8617f},
      {0.8505f, 0.7855f, 0.8399f, 0.8539f},
      {0.8505f, 0.8505f, 0.8851f, 0.8355f},
    },
    { // length bin 2
      {0.9016f, 0.8979f, 0.9073f, 0.9207f},
      {0.8957f, 0.8846f, 0.8929f, 0.8970f},
      {0.8957f, 0.8896f, 0.8824f, 0.8944f},
      {0.8957f, 0.8957f, 0.8882f, 0.9024f},
    },
    { // length bin 3
      {0.8183f, 0.8294f, 0.8430f, 0.8552f},
      {0.8370f, 0.8257f, 0.8327f, 0.8632f},
      {0.8370f, 0.8520f, 0.8530f, 0.8462f},
      {0.8370f, 0.8370f, 0.8387f, 0.8588f},
    },
    { // length bin 4
      {0.6616f, 0.6009f, 0.6254f, 0.6452f},
      {0.6019f, 0.5848f, 0.5744f, 0.5690f},
      {0.6019f, 0.6019f, 0.5627f, 0.5556f},
      {0.6019f, 0.6019f, 0.6019f, 0.5524f},
    },
  },
  { // score bin 5
    { // length bin 0
      {0.8212f, 0.8149f, 0.8279f, 0.8434f},
      {0.8112f, 0.8016f, 0.8070f, 0.8390f},
      {0.8112f, 0.7626f, 0.7877f, 0.8052f},
      {0.8112f, 0.8112f, 0.7950f, 0.7973f},
    },
    { // length bin 1
      {0.8724f, 0.8730f, 0.8873f, 0.8768f},
      {0.8656f, 0.8447f, 0.8618f, 0.8878f},
      {0.8656f, 0.8434f, 0.8436f, 0.8603f},
      {0.8656f, 0.8656f, 0.8411f, 0.8535f},
    },
    { // length bin 2
      {0.9156f, 0.9028f, 0.9198f, 0.8818f},
      {0.9035f, 0.8800f, 0.9073f, 0.9264f},
      {0.9035f, 0.9102f, 0.9005f, 0.9080f},
      {0.9035f, 0.9035f, 0.8203f, 0.8764f},
    },
    { // length bin 3
      {0.8445f, 0.8512f, 0.8498f, 0.8269f},
      {0.8505f, 0.8488f, 0.8620f, 0.8842f},
      {0.8505f, 0.8485f, 0.8377f, 0.8535f},
      {0.8505f, 0.8505f, 0.9000f, 0.8541f},
    },
    { // length bin 4
      {0.6641f, 0.6075f, 0.6216f, 0.6333f},
      {0.6187f, 0.5975f, 0.6082f, 0.5000f},
      {0.6187f, 0.6187f, 0.5907f, 0.6906f},
      {0.6187f, 0.6187f, 0.6187f, 0.5905f},
    },
  },
  { // score bin 6
    { // length bin 0
      {0.8290f, 0.8348f, 0.8558f, 0.8367f},
      {0.8257f, 0.7892f, 0.8289f, 0.8563f},
      {0.8257f, 0.8184f, 0.7958f, 0.8257f},
      {0.8257f, 0.8257f, 0.7955f, 0.7851f},
    },
    { // length bin 1
      {0.8852f, 0.8817f, 0.8903f, 0.9271f},
      {0.8755f, 0.8548f, 0.8765f, 0.8822f},
      {0.8755f, 0.8565f, 0.8552f, 0.8772f},
      {0.8755f, 0.8755f, 0.8385f, 0.8498f},
    },
    { // length bin 2
      {0.9204f, 0.9123f, 0.9245f, 0.9425f},
      {0.9113f, 0.8928f, 0.9167f, 0.9491f},
      {0.9113f, 0.9021f, 0.8910f, 0.9101f},
      {0.9113f, 0.9113f, 0.9219f, 0.8979f},
    },
    { // length bin 3
      {0.8483f, 0.8496f, 0.8635f, 0.8480f},
      {0.8561f, 0.8600f, 0.8567f, 0.8571f},
      {0.8561f, 0.8971f, 0.8574f, 0.8655f},
      {0.8561f, 0.8561f, 0.8684f, 0.8602f},
    },
    { // length bin 4
      {0.6431f, 0.6490f, 0.6548f, 0.6875f},
      {0.6347f, 0.6692f, 0.6054f, 0.6286f},
      {0.6347f, 0.6347f, 0.6532f, 0.5625f},
      {0.6347f, 0.6347f, 0.6347f, 0.5729f},
    },
  },
  { // score bin 7
    { // length bin 0
      {0.8394f, 0.8322f, 0.8434f, 0.8785f},
      {0.8258f, 0.7947f, 0.8352f, 0.8386f},
      {0.8258f, 0.8100f, 0.8057f, 0.8214f},
      {0.8258f, 0.8258f, 0.8031f, 0.7787f},
    },
    { // length bin 1
      {0.8836f, 0.8920f, 0.8881f, 0.9157f},
      {0.8761f, 0.8407f, 0.8766f, 0.9186f},
      {0.8761f, 0.8228f, 0.8476f, 0.8806f},
      {0.8761f, 0.8761f, 0.8692f, 0.8417f},
    },
    { // length bin 2
      {0.9252f, 0.9249f, 0.9301f, 0.9066f},
      {0.9188f, 0.9058f, 0.9156f, 0.9452f},
      {0.9188f, 0.9119f, 0.9014f, 0.9155f},
      {0.9188f, 0.9188f, 0.9200f, 0.9142f},
    },
    { // length bin 3
      {0.8441f, 0.8430f, 0.8461f, 0.8636f},
      {0.8511f, 0.8606f, 0.8542f, 0.8598f},
      {0.8511f, 0.8614f, 0.8533f, 0.8588f},
      {0.8511f, 0.8511f, 0.8767f, 0.8700f},
    },
    { // length bin 4
      {0.6325f, 0.6270f, 0.6221f, 0.6228f},
      {0.6228f, 0.6531f, 0.5570f, 0.6228f},
      {0.6228f, 0.6228f, 0.6533f, 0.6053f},
      {0.6228f, 0.6228f, 0.6228f, 0.6494f},
    },
  },
  { // score bin 8
    { // length bin 0
      {0.8566f, 0.8465f, 0.8640f, 0.8930f},
      {0.8419f, 0.8072f, 0.8457f, 0.8829f},
      {0.8419f, 0.7887f, 0.8195f, 0.8463f},
      {0.8419f, 0.8419f, 0.7565f, 0.7977f},
    },
    { // length bin 1
      {0.8989f, 0.8879f, 0.9074f, 0.9234f},
      {0.8855f, 0.8801f, 0.8892f, 0.8983f},
      {0.8855f, 0.8977f, 0.8541f, 0.8942f},
      {0.8855f, 0.8855f, 0.8062f, 0.8507f},
    },
    { // length bin 2
      {0.9281f, 0.9204f, 0.9336f, 0.9267f},
      {0.9170f, 0.8948f, 0.9287f, 0.9364f},
      {0.9170f, 0.8782f, 0.9020f, 0.9204f},
      {0.9170f, 0.9170f, 0.9053f, 0.8875f},
    },
    { // length bin 3
      {0.8565f, 0.8415f, 0.8502f, 0.8133f},
      {0.8597f, 0.8574f, 0.8722f, 0.8750f},
      {0.8597f, 0.8913f, 0.8691f, 0.8934f},
      {0.8597f, 0.8597f, 0.7872f, 0.8790f},
    },
    { // length bin 4
      {0.6724f, 0.5965f, 0.6154f, 0.6004f},
      {0.6004f, 0.7416f, 0.5429f, 0.6004f},
      {0.6004f, 0.6004f, 0.5172f, 0.5051f},
      {0.6004f, 0.6004f, 0.6004f, 0.6154f},
    },
  },
  { // score bin 9
    { // length bin 0
      {0.9047f, 0.9067f, 0.9099f, 0.9180f},
      {0.8941f, 0.8856f, 0.8914f, 0.9038f},
      {0.8941f, 0.8157f, 0.8597f, 0.8907f},
      {0.8941f, 0.8941f, 0.8065f, 0.8511f},
    },
    { // length bin 1
      {0.9311f, 0.9264f, 0.9292f, 0.8827f},
      {0.9166f, 0.8978f, 0.9164f, 0.9284f},
      {0.9166f, 0.8377f, 0.8986f, 0.9107f},
      {0.9166f, 0.9166f, 0.8358f, 0.8928f},
    },
    { // length bin 2
      {0.9370f, 0.9349f, 0.9352f, 0.8990f},
      {0.9325f, 0.9131f, 0.9315f, 0.9834f},
      {0.9325f, 0.9326f, 0.9255f, 0.9422f},
      {0.9325f, 0.9325f, 0.8333f, 0.9251f},
    },
    { // length bin 3
      {0.8610f, 0.8635f, 0.8868f, 0.8571f},
      {0.8723f, 0.8608f, 0.8754f, 0.9268f},
      {0.8723f, 0.9487f, 0.8480f, 0.8847f},
      {0.8723f, 0.8723f, 0.9333f, 0.9100f},
    },
    { // length bin 4
      {0.6126f, 0.6105f, 0.6207f, 0.6334f},
      {0.6334f, 0.8158f, 0.6000f, 0.6334f},
      {0.6334f, 0.6334f, 0.5897f, 0.6774f},
      {0.6334f, 0.6334f, 0.6334f, 0.6334f},
    },
  },
};

} // namespace detail_4d

inline size_t find_bin(float val, const float* edges, size_t n_bins) {
    size_t bin = 0;
    for (size_t i = 1; i <= n_bins; ++i) {
        if (val >= edges[i]) bin = i;
        else break;
    }
    return std::min(bin, n_bins - 1);
}

inline float calibrate_score_4d(float score, size_t length, float damage_pct, float damage_signal) {
    size_t s_bin = find_bin(score, detail_4d::SCORE_EDGES, detail_4d::N_SCORE_BINS);
    size_t l_bin = find_bin(static_cast<float>(length), detail_4d::LENGTH_EDGES, detail_4d::N_LENGTH_BINS);
    size_t d_bin = find_bin(damage_pct, detail_4d::DAMAGE_EDGES, detail_4d::N_DAMAGE_BINS);
    size_t a_bin = find_bin(damage_signal, detail_4d::ANCIENT_EDGES, detail_4d::N_ANCIENT_BINS);
    return detail_4d::CALIBRATION_4D[s_bin][l_bin][d_bin][a_bin];
}

} // namespace agp