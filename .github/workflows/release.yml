name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build binary (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            artifact: dart-linux-x86_64
          - os: macos-14
            artifact: dart-macos-arm64

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -q
          sudo apt-get install -y zlib1g-dev libzstd-dev pkg-config

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install zstd pkg-config

      - name: Configure
        run: |
          if [ "$(uname)" = "Darwin" ]; then
            export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:$PKG_CONFIG_PATH"
          fi
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=OFF

      - name: Build
        run: cmake --build build --parallel

      - name: Rename binary
        run: cp build/dart ${{ matrix.artifact }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}

  release:
    name: Create GitHub release
    needs: build
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Compute SHA256 of source tarball
        id: sha256
        run: |
          TAG=${GITHUB_REF_NAME}
          URL="https://github.com/${{ github.repository }}/archive/refs/tags/${TAG}.tar.gz"
          curl -sL "$URL" -o source.tar.gz
          SHA=$(sha256sum source.tar.gz | awk '{print $1}')
          echo "sha256=$SHA" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Update conda recipe SHA256
        run: |
          sed -i "s/sha256:.*/sha256: ${{ steps.sha256.outputs.sha256 }}/" conda_recipe/meta.yaml
          sed -i "s/{% set version = .* %}/{% set version = \"${GITHUB_REF_NAME#v}\" %}/" conda_recipe/meta.yaml

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/dart-linux-x86_64/dart-linux-x86_64
            artifacts/dart-macos-arm64/dart-macos-arm64
          body: |
            ## Installation

            **conda (recommended):**
            ```bash
            conda install -c bioconda dart-adna
            ```

            **Pre-built binaries:** download from assets below, make executable (`chmod +x dart-*`).

            **From source:**
            ```bash
            cmake -B build -DCMAKE_BUILD_TYPE=Release && cmake --build build --parallel
            ```

            SHA256 of source tarball: `${{ steps.sha256.outputs.sha256 }}`
